{% extends 'thoughtify/base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="glass-morphism rounded-2xl p-8 relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-violet-500/10 to-cyan-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        
        <div class="relative z-10">
            <h2 class="text-2xl font-semibold text-gray-100 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit Thought
            </h2>

            <form method="post" class="space-y-6" id="update-thought-form">
                {% csrf_token %}
                <div class="relative group">
                    <textarea
                        name="content"
                        rows="3"
                        class="block w-full px-4 py-3 bg-dark-lighter text-gray-100 border border-gray-700 rounded-xl focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all input-glow resize-none"
                        placeholder="Update your thought..."
                        maxlength="280"
                        required
                    >{{ form.content.value }}</textarea>
                    <div class="absolute bottom-3 right-4 text-sm text-gray-400" id="char-count">0/280</div>
                </div>

                <div class="relative group">
                    <select
                        name="emotion_tag"
                        class="block w-full px-4 py-3 bg-dark-lighter text-gray-100 border border-gray-700 rounded-xl focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all input-glow appearance-none"
                        required
                    >
                        <option value="">How are you feeling?</option>
                        {% for tag in form.emotion_tag.field.queryset %}
                            <option value="{{ tag.id }}" {% if tag.id == form.emotion_tag.value.id %}selected{% endif %}>
                                {{ tag.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <a href="{% url 'feed' %}" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-xl text-gray-300 glass-morphism hover:text-violet-400 transition-all duration-300">
                        Cancel
                    </a>
                    <button type="submit" class="inline-flex items-center px-6 py-2 text-sm font-medium rounded-xl text-white bg-gradient-to-r from-violet-600 to-cyan-600 hover:from-violet-700 hover:to-cyan-700 transition-all shadow-lg shadow-violet-500/25 hover:shadow-violet-500/40 pulse-glow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Character counter
        const textarea = document.querySelector('textarea[name="content"]');
        const maxLength = 280;
        const charCount = document.getElementById('char-count');
        
        const updateCharCount = () => {
            const currentLength = textarea.value.length;
            charCount.textContent = `${currentLength}/${maxLength}`;
            
            // Add visual feedback as user approaches limit
            if (currentLength >= maxLength * 0.9) {
                charCount.classList.add('text-red-400');
            } else if (currentLength >= maxLength * 0.7) {
                charCount.classList.add('text-yellow-400');
                charCount.classList.remove('text-red-400');
            } else {
                charCount.classList.remove('text-yellow-400', 'text-red-400');
            }
        };

        // Initialize character count
        updateCharCount();
        
        // Update on input
        textarea.addEventListener('input', updateCharCount);
        
        // Auto-resize textarea
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Form validation
        const form = document.getElementById('update-thought-form');
        form.addEventListener('submit', function(e) {
            const content = textarea.value.trim();
            const emotionTag = form.querySelector('select[name="emotion_tag"]').value;
            let isValid = true;
            
            // Reset previous error states
            form.querySelectorAll('.error-message').forEach(el => el.remove());
            form.querySelectorAll('.error-input').forEach(el => el.classList.remove('error-input'));
            
            const showError = (element, message) => {
                isValid = false;
                element.classList.add('error-input');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-red-400 text-sm mt-1 error-message';
                errorDiv.textContent = message;
                element.parentNode.appendChild(errorDiv);
            };
            
            if (!content) {
                showError(textarea, 'Please enter your thought');
            }
            
            if (!emotionTag) {
                showError(form.querySelector('select'), 'Please select how you are feeling');
            }
            
            if (content.length > maxLength) {
                showError(textarea, `Your thought is too long. Maximum ${maxLength} characters allowed.`);
            }
            
            if (!isValid) {
                e.preventDefault();
                // Animate the form to show error
                gsap.to(form, {
                    x: [-10, 10, -10, 10, 0],
                    duration: 0.4,
                    ease: "power2.out"
                });
            }
        });
    });
</script>
{% endblock %} 